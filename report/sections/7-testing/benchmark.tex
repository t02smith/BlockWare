% chktex-file 44

\newpage
\section{Benchmarking}\label{sec:benchmark}

This project uses benchmarking to determine the overall performance and scalability of the application, whilst also being useful in discovering any bottlenecks or bugs.
\x
To ensure consistency in these results, I've included the following constraints:

\begin{itemize}
  \item All benchmarks should be ran on the same hardware using the same OS,
  \item All tests should be ran three times,
  \item Test data should be pseudo-random, and
  \item All projects should aim for the target size of 40GB to match the average game size given in Section~\ref{subsec:design-data}.
\end{itemize}

\subsection*{Number of Peers}

For each run, we will create a project with 500 files, each of size 80MB and a shard size of 4MiB. We will then run $N$ peers locally to simulate a perfect network connection.

\begin{longtable}{l|llll|}
  \cline{2-5}\cline{2-5}\cline{2-5}\cline{2-5}\cline{2-5}
  & \multicolumn{4}{c|}{\hdr{Runtime (s)}}\\ \hline
  \multicolumn{1}{|l|}{\hdr{Peers}} 
  & \multicolumn{1}{l|}{\hdr{1}} 
  & \multicolumn{1}{l|}{\hdr{2}} 
  & \multicolumn{1}{l|}{\hdr{3}} & \hdr{avg.}  \\ \hline
  \multicolumn{1}{|l|}{1} & 
  \multicolumn{1}{l|}{56} & 
  \multicolumn{1}{l|}{65} & 
  \multicolumn{1}{l|}{63} &  
  61.3
  \\ \hline
  \multicolumn{1}{|l|}{2} & 
  \multicolumn{1}{l|}{65} & 
  \multicolumn{1}{l|}{64} & 
  \multicolumn{1}{l|}{60} &  
  63
  \\ \hline
  \multicolumn{1}{|l|}{4} & 
  \multicolumn{1}{l|}{66} & 
  \multicolumn{1}{l|}{65} & 
  \multicolumn{1}{l|}{65} &  
  65.7
  \\ \hline
  \multicolumn{1}{|l|}{8} & 
  \multicolumn{1}{l|}{66} & 
  \multicolumn{1}{l|}{62} & 
  \multicolumn{1}{l|}{60} &  
  62.7
  \\ \hline
  \caption{How varying the peer count affects download speed}
\end{longtable}

\noindent
These results shows us that having more peers won't typically increase the download speed. This indicates that there may be a bottleneck elsewhere such as writing the data to disk. However, it is still useful to connect to many peers as connections to peers are not guaranteed to be fast or perfect.

\subsection*{Game Size}

For each run, we will create a project with $F$ files of size $S$MB, such that $F\times S = 40GB$, and a shard size of 4MiB. We will then run 1 peer locally to simulate a perfect network connection.

\begin{longtable}{rr|llll|}
  \hline
  \multicolumn{2}{|c|}{\hdr{File}}
  & \multicolumn{4}{c|}{\hdr{Runtime (s)}}
  \\\hline
  \multicolumn{1}{|l|}{\hdr{Count}} 
  & \hdr{Size (MB)}
  & \multicolumn{1}{l|}{\hdr{1}} 
  & \multicolumn{1}{l|}{\hdr{2}} 
  & \multicolumn{1}{l|}{\hdr{3}} 
  & \hdr{avg.}
  \\ \hline
  \multicolumn{1}{|r|}{200} 
  & 200
  & \multicolumn{1}{l|}{57} 
  & \multicolumn{1}{l|}{55} 
  & \multicolumn{1}{l|}{58} 
  &  57
  \\\hline
  \multicolumn{1}{|r|}{100} 
  & 400
  & \multicolumn{1}{l|}{56} 
  & \multicolumn{1}{l|}{52} 
  & \multicolumn{1}{l|}{58} 
  & 55
  \\\hline
  \multicolumn{1}{|r|}{50} 
  & 800
  & \multicolumn{1}{l|}{110} 
  & \multicolumn{1}{l|}{109} 
  & \multicolumn{1}{l|}{110} 
  & 110
  \\\hline
  \multicolumn{1}{|r|}{25} 
  & 1,600
  & \multicolumn{1}{l|}{110} 
  & \multicolumn{1}{l|}{108} 
  & \multicolumn{1}{l|}{114} 
  & 111
  \\\hline
  \multicolumn{1}{|r|}{5} 
  & 8,000
  & \multicolumn{1}{l|}{311} 
  & \multicolumn{1}{l|}{318} 
  & \multicolumn{1}{l|}{311} 
  & 313
  \\\hline
  \multicolumn{1}{|r|}{1} 
  & 40,000
  & \multicolumn{1}{l|}{1,548} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  &  
  \\\hline
  \caption{How varying file count and size affects download speed}
\end{longtable}

\noindent From these results, we can see that distributing data across a larger pool of files results in a greater download speed.
This occurred for several reasons:

\begin{enumerate}
  \item A file can only be written to by one process at one time so having less files will reduce the potential for parallelisation.
  \item For each block downloaded: we open a writer to a file, write a single block, and close the writer. This adds a lot of overhead for files that have many blocks.
\end{enumerate}

\subsection*{Block Size}

For each run we will create a new project with 500 files, each of size 80MB, and a shard size of $B$MiB. We will then run 1 peer locally to simulate a perfect network connection.

\begin{longtable}{rr|llll|}
  \cline{3-6}\cline{3-6}\cline{3-6}\cline{3-6}\cline{3-6}
  && \multicolumn{4}{l|}{\hdr{Runtime (s)}}
  \\ \hline
  \multicolumn{1}{|l|}{\hdr{Block Size (MiB)}} 
  & \multicolumn{1}{|l|}{\hdr{Total Blocks}} 
  & \multicolumn{1}{l|}{\hdr{1}} 
  & \multicolumn{1}{l|}{\hdr{2}} 
  & \multicolumn{1}{l|}{\hdr{3}} 
  & \hdr{avg.}
  \\\hline
  \multicolumn{1}{|r|}{1} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & 
  \\\hline
  \multicolumn{1}{|r|}{2} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & 
  \\\hline
  \multicolumn{1}{|r|}{4} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & 
  \\\hline
  \multicolumn{1}{|r|}{8} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & 
  \\\hline
  \multicolumn{1}{|r|}{16} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & \multicolumn{1}{l|}{} 
  & 
  \\\hline
  \caption{How varying the shard size of the hash tree affects download speed}
\end{longtable}